#ifndef __ast__
#define __ast__

#include <memory>
#include <vector>
#include <string>
#include <iomanip>

#include "token.h"
#include "utils.h"
#include "type.h"

namespace bindlang{

typedef enum{
  ATOM,
  ID,
  DEFINE,
  FUNC,
  CALL,
  TUPLE
} expr_type;


struct Expr {
  int type=-2;
  ~Expr() = default;
  virtual void    show() =0;
  virtual ExprPtr clone()=0;
  Expr(int type):type(type){};
};

using TokenList = std::vector<Token>;

struct ExprEof : Expr{
  ExprEof():Expr(-1){}
  void show(){
    std::cout<<"<Expr EOF >"<<std::endl;
  }
  ExprPtr clone(){
    return std::make_unique<ExprEof>(); 
  }
};

struct ExprAtom : Expr{
  Token literal;
  
  ExprAtom(Token literal)
    : Expr(ATOM),literal(literal){}

  ExprPtr clone() override;

  void show() override {
    std::cout<<BLUE("<Expr ")<<"Atom "<<std::endl;
    std::cout<<std::setw(10)<<std::left<<"  literal:"<<std::endl;
    cout<<std::setw(14)<<' ';literal.show();std::cout<<endl;
    std::cout<<BLUE(" >")<<std::endl;
  }
};

struct ExprId : Expr{
  Token id;
  
  ExprId(Token id)
    : Expr(ID),id(id){}

  ExprPtr clone() override;

  void show() override {
    std::cout<<BLUE("<Expr ")<<"Id "<<std::endl;
    std::cout<<std::setw(10)<<std::left<<"  id:"<<std::endl;
    cout<<std::setw(14)<<' ';id.show();std::cout<<endl;
    std::cout<<BLUE(" >")<<std::endl;
  }
};

struct ExprDefine : Expr{
  Token id;
  ExprPtr expr;
  
  ExprDefine(Token id,ExprPtr expr)
    : Expr(DEFINE),id(id),expr(std::move(expr)){}

  ExprPtr clone() override;

  void show() override {
    std::cout<<BLUE("<Expr ")<<"Define "<<std::endl;
    std::cout<<std::setw(10)<<std::left<<"  id:"<<std::endl;
    cout<<std::setw(14)<<' ';id.show();std::cout<<endl;
    std::cout<<std::setw(10)<<std::left<<"  expr:"<<std::endl;
    cout<<std::setw(14)<<' ';expr->show();std::cout<<endl;
    std::cout<<BLUE(" >")<<std::endl;
  }
};

struct ExprFunc : Expr{
  TokenList params;
  ExprPtr body;
  
  ExprFunc(TokenList params,ExprPtr body)
    : Expr(FUNC),params(std::move(params)),body(std::move(body)){}

  ExprPtr clone() override;

  void show() override {
    std::cout<<BLUE("<Expr ")<<"Func "<<std::endl;
    std::cout<<std::setw(10)<<std::left<<"  params:"<<std::endl;
    for(auto &i:params){
      std::cout<<std::setw(14)<<" ";i.show();std::cout<<endl;
    }
    std::cout<<std::setw(10)<<std::left<<"  body:"<<std::endl;
    cout<<std::setw(14)<<' ';body->show();std::cout<<endl;
    std::cout<<BLUE(" >")<<std::endl;
  }
};

struct ExprCall : Expr{
  ExprPtr callee;
  ExprPtrList args;
  ExprPtrList extra;
  
  ExprCall(ExprPtr callee,ExprPtrList args,ExprPtrList extra)
    : Expr(CALL),callee(std::move(callee)),args(std::move(args)),extra(std::move(extra)){}

  ExprPtr clone() override;

  void show() override {
    std::cout<<BLUE("<Expr ")<<"Call "<<std::endl;
    std::cout<<std::setw(10)<<std::left<<"  callee:"<<std::endl;
    cout<<std::setw(14)<<' ';callee->show();std::cout<<endl;
    std::cout<<std::setw(10)<<std::left<<"  args:"<<std::endl;
    for(auto &i:args){
      std::cout<<std::setw(14)<<" ";i->show();std::cout<<endl;
    }
    std::cout<<std::setw(10)<<std::left<<"  extra:"<<std::endl;
    for(auto &i:extra){
      std::cout<<std::setw(14)<<" ";i->show();std::cout<<endl;
    }
    std::cout<<BLUE(" >")<<std::endl;
  }
};

struct ExprTuple : Expr{
  ExprPtrList container;
  
  ExprTuple(ExprPtrList container)
    : Expr(TUPLE),container(std::move(container)){}

  ExprPtr clone() override;

  void show() override {
    std::cout<<BLUE("<Expr ")<<"Tuple "<<std::endl;
    std::cout<<std::setw(10)<<std::left<<"  container:"<<std::endl;
    for(auto &i:container){
      std::cout<<std::setw(14)<<" ";i->show();std::cout<<endl;
    }
    std::cout<<BLUE(" >")<<std::endl;
  }
};

};
#endif
