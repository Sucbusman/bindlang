#ifndef __ast__
#define __ast__

#include <memory>
#include <vector>
#include <string>
#include <iomanip>

#include "token.h"
#include "utils.h"
#include "type.h"

namespace bindlang{
using std::cout;
using std::end;
using std::setw;
using TokenList = std::vector<Token>;

typedef enum{
  ATOM,
  ID,
  DEFINE,
  SET,
  FUNC,
  CALL,
  TUPLE,
  LIST
} expr_type;


static int idt = 0;
static void showidt(){
  for(int i=0;i<idt;i++) cout<<' '; 
}
static void indent(){idt+=2;};
static void deindent(){if(idt>1)idt-=2;};

struct Expr {
  int type=-2;
  bool protect = false;
  ~Expr() = default;
  virtual void    show() =0;
  virtual ExprPtr clone()=0;
  Expr(int type):type(type){};
  Expr(int type,bool protect)
    :type(type),protect(protect){};
};


struct ExprEof : Expr{
  ExprEof():Expr(-1){}
  void show(){
    cout<<"<Expr EOF >"<<endl;
  }
  ExprPtr clone(){
    return std::make_unique<ExprEof>(); 
  }
};

struct ExprAtom : Expr{
  Token literal;
  
  ExprAtom(Token literal)
    : Expr(ATOM),literal(literal){}

  ExprAtom(Token literal,bool protect)
    : Expr(ATOM,protect),literal(literal){}

  ExprPtr clone() override;

  void show() override {
    showidt();
    cout<<BLUE("<Expr ")<<"Atom ";if(protect) cout<<"+";cout<<endl;
    indent();
    showidt();cout<<"literal:"<<endl;
    indent();
    showidt();literal.show();cout<<endl;deindent();
    deindent();
    showidt();
    cout<<BLUE(">")<<endl;
  }
};

struct ExprId : Expr{
  Token id;
  
  ExprId(Token id)
    : Expr(ID),id(id){}

  ExprId(Token id,bool protect)
    : Expr(ID,protect),id(id){}

  ExprPtr clone() override;

  void show() override {
    showidt();
    cout<<BLUE("<Expr ")<<"Id ";if(protect) cout<<"+";cout<<endl;
    indent();
    showidt();cout<<"id:"<<endl;
    indent();
    showidt();id.show();cout<<endl;deindent();
    deindent();
    showidt();
    cout<<BLUE(">")<<endl;
  }
};

struct ExprDefine : Expr{
  Token id;
  ExprPtr expr;
  
  ExprDefine(Token id,ExprPtr expr)
    : Expr(DEFINE),id(id),expr(std::move(expr)){}

  ExprDefine(Token id,ExprPtr expr,bool protect)
    : Expr(DEFINE,protect),id(id),expr(std::move(expr)){}

  ExprPtr clone() override;

  void show() override {
    showidt();
    cout<<BLUE("<Expr ")<<"Define ";if(protect) cout<<"+";cout<<endl;
    indent();
    showidt();cout<<"id:"<<endl;
    indent();
    showidt();id.show();cout<<endl;deindent();
    showidt();cout<<"expr:"<<endl;
    indent();
    showidt();expr->show();cout<<endl;deindent();
    deindent();
    showidt();
    cout<<BLUE(">")<<endl;
  }
};

struct ExprSet : Expr{
  ExprPtr beset;
  ExprPtr expr;
  
  ExprSet(ExprPtr beset,ExprPtr expr)
    : Expr(SET),beset(std::move(beset)),expr(std::move(expr)){}

  ExprSet(ExprPtr beset,ExprPtr expr,bool protect)
    : Expr(SET,protect),beset(std::move(beset)),expr(std::move(expr)){}

  ExprPtr clone() override;

  void show() override {
    showidt();
    cout<<BLUE("<Expr ")<<"Set ";if(protect) cout<<"+";cout<<endl;
    indent();
    showidt();cout<<"beset:"<<endl;
    indent();
    showidt();beset->show();cout<<endl;deindent();
    showidt();cout<<"expr:"<<endl;
    indent();
    showidt();expr->show();cout<<endl;deindent();
    deindent();
    showidt();
    cout<<BLUE(">")<<endl;
  }
};

struct ExprFunc : Expr{
  TokenList params;
  ExprPtr body;
  
  ExprFunc(TokenList params,ExprPtr body)
    : Expr(FUNC),params(std::move(params)),body(std::move(body)){}

  ExprFunc(TokenList params,ExprPtr body,bool protect)
    : Expr(FUNC,protect),params(std::move(params)),body(std::move(body)){}

  ExprPtr clone() override;

  void show() override {
    showidt();
    cout<<BLUE("<Expr ")<<"Func ";if(protect) cout<<"+";cout<<endl;
    indent();
    showidt();cout<<"params:"<<endl;
    indent();
    for(auto &i:params){
      showidt();i.show();cout<<endl;
    }
deindent();
    
    showidt();cout<<"body:"<<endl;
    indent();
    showidt();body->show();cout<<endl;deindent();
    deindent();
    showidt();
    cout<<BLUE(">")<<endl;
  }
};

struct ExprCall : Expr{
  ExprPtr callee;
  ExprPtrList args;
  ExprPtrList extra;
  
  ExprCall(ExprPtr callee,ExprPtrList args,ExprPtrList extra)
    : Expr(CALL),callee(std::move(callee)),args(std::move(args)),extra(std::move(extra)){}

  ExprCall(ExprPtr callee,ExprPtrList args,ExprPtrList extra,bool protect)
    : Expr(CALL,protect),callee(std::move(callee)),args(std::move(args)),extra(std::move(extra)){}

  ExprPtr clone() override;

  void show() override {
    showidt();
    cout<<BLUE("<Expr ")<<"Call ";if(protect) cout<<"+";cout<<endl;
    indent();
    showidt();cout<<"callee:"<<endl;
    indent();
    showidt();callee->show();cout<<endl;deindent();
    showidt();cout<<"args:"<<endl;
    indent();
    for(auto &i:args){
      showidt();i->show();cout<<endl;
    }
deindent();
    
    showidt();cout<<"extra:"<<endl;
    indent();
    for(auto &i:extra){
      showidt();i->show();cout<<endl;
    }
deindent();
    
    deindent();
    showidt();
    cout<<BLUE(">")<<endl;
  }
};

struct ExprTuple : Expr{
  ExprPtrList container;
  
  ExprTuple(ExprPtrList container)
    : Expr(TUPLE),container(std::move(container)){}

  ExprTuple(ExprPtrList container,bool protect)
    : Expr(TUPLE,protect),container(std::move(container)){}

  ExprPtr clone() override;

  void show() override {
    showidt();
    cout<<BLUE("<Expr ")<<"Tuple ";if(protect) cout<<"+";cout<<endl;
    indent();
    showidt();cout<<"container:"<<endl;
    indent();
    for(auto &i:container){
      showidt();i->show();cout<<endl;
    }
deindent();
    
    deindent();
    showidt();
    cout<<BLUE(">")<<endl;
  }
};

struct ExprList : Expr{
  ExprPtrList container;
  
  ExprList(ExprPtrList container)
    : Expr(LIST),container(std::move(container)){}

  ExprList(ExprPtrList container,bool protect)
    : Expr(LIST,protect),container(std::move(container)){}

  ExprPtr clone() override;

  void show() override {
    showidt();
    cout<<BLUE("<Expr ")<<"List ";if(protect) cout<<"+";cout<<endl;
    indent();
    showidt();cout<<"container:"<<endl;
    indent();
    for(auto &i:container){
      showidt();i->show();cout<<endl;
    }
deindent();
    
    deindent();
    showidt();
    cout<<BLUE(">")<<endl;
  }
};

};
#endif
